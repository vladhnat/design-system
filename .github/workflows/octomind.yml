name: Octomind E2E Tests

on:
  deployment_status:

jobs:
  octomind:
    # Only run if deployment was successful
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      # 1. FETCH PR DATA (deployment_status event doesn't include PR body/title)
      - name: Fetch PR Details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
            });
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              core.setOutput('number', pr.number);
              core.setOutput('title', pr.title);
              // Sanitize body: replace backticks to prevent shell injection, limit length
              const cleanBody = pr.body ? pr.body.replace(/`/g, "'").substring(0, 1500) : "No description provided";
              core.setOutput('body', cleanBody);
            } else {
              core.setOutput('number', 'NONE');
            }

      # 2. EXECUTE EXISTING TESTS
      - name: Run Existing Octomind Tests
        uses: OctoMind-dev/automagically-action-execute@v2
        env:
          OCTOMIND_PULL_REQUEST_NUMBER: ${{ steps.pr_details.outputs.number }}
        with:
          url: '${{ github.event.deployment_status.target_url }}?x-vercel-protection-bypass=${{ secrets.VERCEL_BYPASS_SECRET }}&x-vercel-set-bypass-cookie=true'
          token: ${{ secrets.OCTOMIND_API_KEY }}
          testTargetId: 96ce3c22-add9-4b72-8b31-5d9d0a19c11c
          blocking: false

      # 3. CLI BATCH GENERATION (To discover and test NEW pages)
      - name: Octomind Discovery & Generation
        if: steps.pr_details.outputs.number != 'NONE'
        env:
          # Mapping to env vars prevents backticks in PR body from executing as commands
          PR_TITLE: ${{ steps.pr_details.outputs.title }}
          PR_BODY: ${{ steps.pr_details.outputs.body }}
          OCTOMIND_API_KEY: ${{ secrets.OCTOMIND_API_KEY }}
          TARGET_URL: "${{ github.event.deployment_status.target_url }}?x-vercel-protection-bypass=${{ secrets.VERCEL_BYPASS_SECRET }}&x-vercel-set-bypass-cookie=true"
        run: |
          # 1. Initialize CLI with API Key (Required to prevent "API key is required" error)
          npx @octomind/octomind init \
            --api-key "$OCTOMIND_API_KEY" \
            --test-target-id "96ce3c22-add9-4b72-8b31-5d9d0a19c11c"
          
          # 2. Trigger Batch Generation with the PR Prompt
          # This tells the AI Agent specifically what changed so it finds new pages
          npx @octomind/octomind batch-generation \
            --test-target-id "96ce3c22-add9-4b72-8b31-5d9d0a19c11c" \
            --url "$TARGET_URL" \
            --prompt "I added a new feature. PR Title: $PR_TITLE. PR Description: $PR_BODY. Please find any new pages, buttons, or features mentioned and generate tests for these journeys."