name: Octomind E2E Tests

on:
  deployment_status:

jobs:
  octomind:
    # Only run if deployment was successful
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Get PR Number
        id: pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
            });
            const prNumber = prs.data.length > 0 ? prs.data[0].number : 'NONE';
            console.log("Found PR Number: " + prNumber);
            return prNumber;
          result-encoding: string

      # --- NEW DEBUG STEP ---
      - name: Check PR ID Output
        run: echo "The script found PR ID ${{ steps.pr_number.outputs.result }}"

      # 1. RUN EXISTING TESTS
      - name: Run Octomind Tests
        uses: OctoMind-dev/automagically-action-execute@v2
        env:
          # This provides the PR ID to Octomind's engine manually
          OCTOMIND_PULL_REQUEST_NUMBER: ${{ steps.pr_number.outputs.result }}
        with:
          # Includes your Vercel Bypass Secret
          url: '${{ github.event.deployment_status.target_url }}?x-vercel-protection-bypass=${{ secrets.VERCEL_BYPASS_SECRET }}&x-vercel-set-bypass-cookie=true'
          token: ${{ secrets.OCTOMIND_API_KEY }}
          testTargetId: 96ce3c22-add9-4b72-8b31-5d9d0a19c11c
          blocking: false

      # 2. BATCH GENERATION
      - name: Octomind Batch Generation
        uses: OctoMind-dev/octomind-action-batch-generation@v1
        with:
          # Note: Batch Generation also needs the bypass token on the baseUrl to scan the UI
          baseUrl: '${{ github.event.deployment_status.target_url }}?x-vercel-protection-bypass=${{ secrets.VERCEL_BYPASS_SECRET }}&x-vercel-set-bypass-cookie=true'
          token: ${{ secrets.OCTOMIND_API_KEY }}
          testTargetId: 96ce3c22-add9-4b72-8b31-5d9d0a19c11c
          pullRequestNumber: ${{ steps.pr_number.outputs.result }}
