name: Octomind E2E Tests

on:
  deployment_status: # Keeps tests synced with Vercel's live URL

jobs:
  octomind:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      # Step to find the PR number associated with this deployment's commit
      - name: Get Pull Request Number
        id: pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
            });
            return prs.data.length > 0 ? prs.data[0].number : '';
          result-encoding: string

      - name: Run Octomind Tests
        uses: OctoMind-dev/automagically-action-execute@v2
        with:
          url: ${{ github.event.deployment_status.target_url }}
          token: ${{ secrets.OCTOMIND_API_KEY }}
          testTargetId: 96ce3c22-add9-4b72-8b31-5d9d0a19c11c
          # Pass the PR number found in the step above
          pullRequestNumber: ${{ steps.pr_number.outputs.result }}
          blocking: false
